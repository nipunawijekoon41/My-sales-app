<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Niyashi Store - POS System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        /* Print logic: Everything hidden except the receipt area */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                padding: 20px;
            }
        }
    </style>
</head>
<body class="bg-slate-50 p-4 font-sans">

    <div class="max-w-2xl mx-auto bg-white p-6 rounded-3xl shadow-2xl border-t-8 border-indigo-600">
        <div class="flex justify-between items-center mb-6 border-b pb-4">
            <div>
                <h1 class="text-3xl font-black text-indigo-700 italic">NIYASHI STORE</h1>
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Inventory & Sales Pro</p>
            </div>
            <div class="text-right">
                <p class="text-[10px] font-black text-rose-500 uppercase">Net Profit (Goal)</p>
                <p id="netProfit" class="text-xl font-black text-gray-800">Rs. 0</p>
            </div>
        </div>

        <div class="bg-indigo-50 p-5 rounded-2xl mb-6 border border-indigo-100">
            <h3 class="text-xs font-black text-indigo-900 mb-3 uppercase italic">Add New Stock</h3>
            <div class="space-y-3">
                <input id="itemName" type="text" placeholder="Item Name (eg: Sofa / iPhone)" class="w-full border-2 rounded-xl p-3 outline-none focus:border-indigo-500">
                <div class="grid grid-cols-2 gap-3">
                    <input id="buyPrice" type="number" placeholder="Buying Price" class="border-2 rounded-xl p-3 outline-none focus:border-indigo-500">
                    <input id="sellPrice" type="number" placeholder="Selling Price" class="border-2 rounded-xl p-3 outline-none focus:border-indigo-500">
                </div>
                <button onclick="addItem()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-xl hover:bg-indigo-700 shadow-lg active:scale-95 transition-all uppercase">Save Item</button>
            </div>
        </div>

        <div class="bg-rose-50 p-4 rounded-2xl mb-8 border border-rose-100">
            <h3 class="text-[10px] font-black text-rose-800 mb-2 uppercase">Expenses</h3>
            <div class="flex gap-2">
                <input id="expDesc" type="text" placeholder="Reason" class="flex-1 border-2 rounded-xl p-2 text-sm outline-none focus:border-rose-400">
                <input id="expAmount" type="number" placeholder="Rs." class="w-1/4 border-2 rounded-xl p-2 text-sm outline-none focus:border-rose-400">
                <button onclick="addExpense()" class="bg-rose-600 text-white px-5 rounded-xl font-bold text-xs uppercase shadow-md">Add</button>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-8">
            <div class="bg-white border-2 border-emerald-100 p-4 rounded-2xl text-center">
                <p class="text-[9px] uppercase font-black text-gray-400">Gross Profit</p>
                <p id="totalProfit" class="text-lg font-black text-emerald-600">0</p>
            </div>
            <div class="bg-white border-2 border-rose-100 p-4 rounded-2xl text-center">
                <p class="text-[9px] uppercase font-black text-gray-400">Expenses</p>
                <p id="totalExpenses" class="text-lg font-black text-rose-600">0</p>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h2 class="font-black text-gray-700 uppercase text-xs">Current Stock</h2>
            <button onclick="exportData()" class="text-[9px] bg-gray-800 text-white px-3 py-1 rounded-lg font-bold uppercase hover:bg-black">Backup CSV</button>
        </div>
        <div id="itemList" class="space-y-4"></div>
    </div>

    <div id="receiptBox">
        <div id="printArea" style="padding: 40px; font-family: 'Helvetica', sans-serif; color: #000; background: #fff; width: 100%; border: 1px solid #eee;">
            <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
                <h1 style="margin: 0; font-size: 28px; letter-spacing: 1px;">NIYASHI STORE</h1>
                <p style="margin: 5px 0; font-size: 12px; font-weight: bold; text-transform: uppercase;">Official Sales Receipt</p>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 14px;">
                <div>
                    <p style="margin: 3px 0;"><strong>Date:</strong> <span id="rDate"></span></p>
                    <p style="margin: 3px 0;"><strong>Receipt No:</strong> #<span id="rNo"></span></p>
                </div>
                <div style="text-align: right;">
                    <p style="margin: 3px 0;"><strong>Status:</strong> <span style="color: green; font-weight: bold;">PAID</span></p>
                </div>
            </div>

            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                <thead>
                    <tr style="border-bottom: 2px solid #000; text-align: left; font-size: 12px;">
                        <th style="padding: 10px;">Item Description</th>
                        <th style="padding: 10px; text-align: right;">Total (Rs.)</th>
                    </tr>
                </thead>
                <tbody style="font-size: 16px;">
                    <tr>
                        <td style="padding: 15px 10px; font-weight: bold;" id="rDesc"></td>
                        <td style="padding: 15px 10px; text-align: right; font-weight: bold;" id="rPrice"></td>
                    </tr>
                </tbody>
            </table>

            <div style="border-top: 2px solid #000; padding-top: 15px; text-align: right;">
                <h3 style="margin: 0; font-size: 20px;">Net Total: <span id="rTotal"></span></h3>
            </div>

            <div style="margin-top: 60px; text-align: center; border-top: 1px dashed #ccc; padding-top: 20px;">
                <p style="font-size: 14px; font-weight: bold;">Thank You for Your Business!</p>
                <p style="font-size: 10px; color: #555; margin-top: 5px;">Niyashi Store - Professional Furniture & Electronics</p>
            </div>
        </div>
    </div>

    <script>
        const db = new Dexie("NiyashiNewDB");
        db.version(1).stores({ 
            items: '++id, name, buyPrice, sellPrice, status, date',
            expenses: '++id, desc, amount'
        });

        async function addItem() {
            const name = document.getElementById('itemName').value;
            const buy = parseFloat(document.getElementById('buyPrice').value);
            const sell = parseFloat(document.getElementById('sellPrice').value);
            if(name && !isNaN(buy) && !isNaN(sell)) {
                await db.items.add({ name, buyPrice: buy, sellPrice: sell, status: 'Available', date: new Date().toLocaleDateString() });
                document.getElementById('itemName').value = '';
                document.getElementById('buyPrice').value = '';
                document.getElementById('sellPrice').value = '';
                showData();
            }
        }

        async function addExpense() {
            const desc = document.getElementById('expDesc').value;
            const amount = parseFloat(document.getElementById('expAmount').value);
            if(desc && !isNaN(amount)) {
                await db.expenses.add({ desc, amount });
                document.getElementById('expDesc').value = '';
                document.getElementById('expAmount').value = '';
                showData();
            }
        }

        async function toggleStatus(id, currentStatus) {
            await db.items.update(id, { status: currentStatus === 'Available' ? 'Sold' : 'Available' });
            showData();
        }

        async function deleteItem(id) { if(confirm("Delete this?")) { await db.items.delete(id); showData(); } }

        // --- FIXED PRINT FUNCTION ---
        async function printReceipt(id) {
            const item = await db.items.get(id);
            if(!item) return;

            // Mapping details to receipt
            document.getElementById('rNo').innerText = 1000 + item.id;
            document.getElementById('rDate').innerText = item.date;
            document.getElementById('rDesc').innerText = item.name.toUpperCase();
            document.getElementById('rPrice').innerText = item.sellPrice.toLocaleString();
            document.getElementById('rTotal').innerText = "Rs. " + item.sellPrice.toLocaleString();

            // Trigger Print
            window.print();
        }

        async function showData() {
            const allItems = await db.items.toArray();
            const allExpenses = await db.expenses.toArray();
            const listDiv = document.getElementById('itemList');
            let grossProf = 0;
            let expensesTotal = 0;

            listDiv.innerHTML = "";
            
            allItems.reverse().forEach(item => {
                const profit = item.sellPrice - item.buyPrice;
                if(item.status === 'Sold') grossProf += profit;

                listDiv.innerHTML += `
                    <div class="bg-white p-4 rounded-2xl border-2 ${item.status === 'Sold' ? 'border-gray-100 opacity-60' : 'border-indigo-50 shadow-sm'} flex justify-between items-center">
                        <div>
                            <p class="font-black text-gray-800 uppercase text-xs">${item.name}</p>
                            <p class="text-[9px] text-gray-400 font-bold">Price: Rs. ${item.sellPrice.toLocaleString()}</p>
                            <div class="flex gap-2 mt-3">
                                <button onclick="toggleStatus(${item.id}, '${item.status}')" class="text-[8px] px-2 py-1 rounded-full font-black border uppercase ${item.status === 'Available' ? 'bg-emerald-50 text-emerald-600 border-emerald-200' : 'bg-gray-100 text-gray-500 border-gray-200'}">${item.status}</button>
                                <button onclick="printReceipt(${item.id})" class="text-[8px] px-2 py-1 rounded-full font-black bg-indigo-600 text-white uppercase shadow-sm">Receipt</button>
                                <button onclick="deleteItem(${item.id})" class="text-rose-300 px-2 font-bold text-xs">X</button>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-black ${profit >= 0 ? 'text-emerald-600' : 'text-rose-600'}">Rs. ${profit.toLocaleString()}</p>
                        </div>
                    </div>`;
            });

            allExpenses.forEach(e => expensesTotal += e.amount);
            document.getElementById('totalProfit').innerText = "Rs. " + grossProf.toLocaleString();
            document.getElementById('totalExpenses').innerText = "Rs. " + expensesTotal.toLocaleString();
            document.getElementById('netProfit').innerText = "Rs. " + (grossProf - expensesTotal).toLocaleString();
        }

        async function exportData() {
            const allItems = await db.items.toArray();
            let csv = "Item,Cost,Sale,Status,Date\n";
            allItems.forEach(i => csv += `${i.name},${i.buyPrice},${i.sellPrice},${i.status},${i.date}\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'Niyashi_Backup.csv');
            a.click();
        }

        showData();
    </script>
</body>
</html>